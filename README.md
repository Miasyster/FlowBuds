# åŸºäºæ¶ˆæ¯æ€»çº¿çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

ä¸€ä¸ªå®Œæ•´çš„ Python å®ç°ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨æ¶ˆæ¯æ€»çº¿æ¶æ„å®ç°å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…çš„å¹¶å‘åœºæ™¯ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [API æ–‡æ¡£](#api-æ–‡æ¡£)
- [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
- [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªè½»é‡çº§çš„æ¶ˆæ¯æ€»çº¿ç³»ç»Ÿï¼Œé‡‡ç”¨**å‘å¸ƒ-è®¢é˜…æ¨¡å¼**ï¼Œè§£å†³å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…åä½œé—®é¢˜ã€‚

### ç‰¹æ€§

âœ… **è§£è€¦è®¾è®¡** - ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€šè¿‡æ¶ˆæ¯æ€»çº¿å®Œå…¨è§£è€¦  
âœ… **ç±»å‹è·¯ç”±** - æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹çš„æ™ºèƒ½è·¯ç”±  
âœ… **å¤šæ’­æœºåˆ¶** - ä¸€æ¡æ¶ˆæ¯å¯è¢«å¤šä¸ªè®¢é˜…è€…æ¥æ”¶  
âœ… **çº¿ç¨‹å®‰å…¨** - ä½¿ç”¨çº¿ç¨‹é”ä¿è¯å¹¶å‘å®‰å…¨  
âœ… **çµæ´»è®¢é˜…** - æ¶ˆè´¹è€…å¯è®¢é˜…å¤šç§æ¶ˆæ¯ç±»å‹  
âœ… **ç»Ÿè®¡ç›‘æ§** - å†…ç½®æ¶ˆæ¯å¤„ç†ç»Ÿè®¡åŠŸèƒ½  

## æ ¸å¿ƒæ¦‚å¿µ

### æ¶ˆæ¯æ€»çº¿ (Message Bus)

æ¶ˆæ¯æ€»çº¿æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ï¼š
- ç®¡ç†æ‰€æœ‰æ¶ˆæ¯ç±»å‹çš„è®¢é˜…è€…åˆ—è¡¨
- æ¥æ”¶ç”Ÿäº§è€…å‘å¸ƒçš„æ¶ˆæ¯
- æ ¹æ®æ¶ˆæ¯ç±»å‹å°†æ¶ˆæ¯åˆ†å‘ç»™å¯¹åº”çš„è®¢é˜…è€…
- æä¾›è®¢é˜…/å–æ¶ˆè®¢é˜…æ¥å£

### ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

```
ç”Ÿäº§è€… 1 â”€â”€â”
ç”Ÿäº§è€… 2 â”€â”€â”¤
ç”Ÿäº§è€… 3 â”€â”€â”¼â”€â”€> æ¶ˆæ¯æ€»çº¿ â”€â”€â”¼â”€â”€> æ¶ˆè´¹è€… 1
ç”Ÿäº§è€… 4 â”€â”€â”˜               â”œâ”€â”€> æ¶ˆè´¹è€… 2
                           â””â”€â”€> æ¶ˆè´¹è€… 3
```

### å‘å¸ƒ-è®¢é˜…æ¨¡å¼

- **å‘å¸ƒ (Publish)**: ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°æ€»çº¿ï¼Œæ— éœ€çŸ¥é“è°ä¼šæ¶ˆè´¹
- **è®¢é˜… (Subscribe)**: æ¶ˆè´¹è€…è®¢é˜…æ„Ÿå…´è¶£çš„æ¶ˆæ¯ç±»å‹ï¼Œè‡ªåŠ¨æ¥æ”¶ç›¸å…³æ¶ˆæ¯

## æ¶æ„è®¾è®¡

### ç±»ç»“æ„

```
MessageType (æšä¸¾)
    â”œâ”€â”€ ORDER      - è®¢å•æ¶ˆæ¯
    â”œâ”€â”€ PAYMENT    - æ”¯ä»˜æ¶ˆæ¯
    â”œâ”€â”€ INVENTORY  - åº“å­˜æ¶ˆæ¯
    â”œâ”€â”€ SHIPPING   - ç‰©æµæ¶ˆæ¯
    â””â”€â”€ NOTIFICATION - é€šçŸ¥æ¶ˆæ¯

Message (æ¶ˆæ¯å¯¹è±¡)
    â”œâ”€â”€ msg_type   - æ¶ˆæ¯ç±»å‹
    â”œâ”€â”€ content    - æ¶ˆæ¯å†…å®¹
    â”œâ”€â”€ sender     - å‘é€è€…
    â””â”€â”€ timestamp  - æ—¶é—´æˆ³

MessageBus (æ¶ˆæ¯æ€»çº¿)
    â”œâ”€â”€ subscribe()     - è®¢é˜…æ¶ˆæ¯
    â”œâ”€â”€ unsubscribe()   - å–æ¶ˆè®¢é˜…
    â”œâ”€â”€ publish()       - å‘å¸ƒæ¶ˆæ¯
    â””â”€â”€ get_stats()     - è·å–ç»Ÿè®¡

Producer (ç”Ÿäº§è€…)
    â””â”€â”€ run()          - ç”Ÿäº§å¹¶å‘å¸ƒæ¶ˆæ¯

Consumer (æ¶ˆè´¹è€…)
    â””â”€â”€ run()          - è®¢é˜…å¹¶æ¶ˆè´¹æ¶ˆæ¯
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.7+
- æ ‡å‡†åº“: `threading`, `queue`, `time`, `enum`

### è¿è¡Œç¤ºä¾‹

```bash
python producer_consumer.py
```

### åŸºç¡€ç”¨æ³•

```python
from message_bus import MessageBus, Producer, Consumer, MessageType

# åˆ›å»ºæ¶ˆæ¯æ€»çº¿
bus = MessageBus("æˆ‘çš„æ€»çº¿")

# åˆ›å»ºç”Ÿäº§è€…
producer = Producer("ç”Ÿäº§è€…A", bus, MessageType.ORDER, count=5)

# åˆ›å»ºæ¶ˆè´¹è€…ï¼ˆè®¢é˜…è®¢å•æ¶ˆæ¯ï¼‰
consumer = Consumer("æ¶ˆè´¹è€…X", bus, [MessageType.ORDER], count=5)

# å¯åŠ¨çº¿ç¨‹
producer.start()
consumer.start()

# ç­‰å¾…å®Œæˆ
producer.join()
consumer.join()
```

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å•åœºæ™¯

**åœºæ™¯**: è®¢å•ç³»ç»Ÿï¼Œ2ä¸ªè®¢å•æœåŠ¡ç”Ÿäº§è®¢å•ï¼Œ2ä¸ªå¤„ç†å™¨æ¶ˆè´¹è®¢å•

```python
def demo_simple():
    bus = MessageBus("è®¢å•æ€»çº¿")
    
    producers = [
        Producer("è®¢å•æœåŠ¡A", bus, MessageType.ORDER, count=3),
        Producer("è®¢å•æœåŠ¡B", bus, MessageType.ORDER, count=3),
    ]
    
    consumers = [
        Consumer("è®¢å•å¤„ç†å™¨1", bus, [MessageType.ORDER], count=3),
        Consumer("è®¢å•å¤„ç†å™¨2", bus, [MessageType.ORDER], count=3),
    ]
```

**è¾“å‡ºç¤ºä¾‹**:
```
ğŸ“¤ [è®¢å•æ€»çº¿] å‘å¸ƒæ¶ˆæ¯ #1: [è®¢å•] è®¢å•æœåŠ¡A: è®¢å•æ•°æ®-1
   â†’ å°†åˆ†å‘ç»™ 2 ä¸ªè®¢é˜…è€…
   âœ“ [æ¶ˆè´¹è€…-è®¢å•å¤„ç†å™¨1] å¤„ç†: [è®¢å•] è®¢å•æœåŠ¡A: è®¢å•æ•°æ®-1
```

### ç¤ºä¾‹ 2: ç”µå•†ç³»ç»Ÿ

**åœºæ™¯**: è®¢å•ã€æ”¯ä»˜ã€åº“å­˜ã€ç‰©æµå¤šä¸ªå­ç³»ç»Ÿé€šè¿‡æ¶ˆæ¯æ€»çº¿åä½œ

- **è®¢å•å¤„ç†å™¨**: è®¢é˜…è®¢å•å’Œæ”¯ä»˜æ¶ˆæ¯
- **åº“å­˜ç®¡ç†å™¨**: è®¢é˜…è®¢å•å’Œåº“å­˜æ¶ˆæ¯
- **ç‰©æµåè°ƒå™¨**: è®¢é˜…æ”¯ä»˜å’Œç‰©æµæ¶ˆæ¯
- **é€šçŸ¥æœåŠ¡**: è®¢é˜…æ‰€æœ‰ç±»å‹æ¶ˆæ¯

```python
consumers = [
    Consumer("è®¢å•å¤„ç†å™¨", bus, [MessageType.ORDER, MessageType.PAYMENT], count=4),
    Consumer("åº“å­˜ç®¡ç†å™¨", bus, [MessageType.ORDER, MessageType.INVENTORY], count=4),
    Consumer("ç‰©æµåè°ƒå™¨", bus, [MessageType.PAYMENT, MessageType.SHIPPING], count=4),
    Consumer("é€šçŸ¥æœåŠ¡", bus, [MessageType.ORDER, MessageType.PAYMENT, 
                               MessageType.INVENTORY, MessageType.SHIPPING], count=8),
]
```

### ç¤ºä¾‹ 3: æµæ°´çº¿å¤„ç†

**åœºæ™¯**: è®¢å• â†’ æ”¯ä»˜ â†’ å‘è´§çš„é“¾å¼å¤„ç†

```
åˆå§‹è®¢å• â†’ [è®¢å•æ¶ˆæ¯] â†’ æ”¯ä»˜å¤„ç† â†’ [æ”¯ä»˜æ¶ˆæ¯] â†’ å‘è´§å¤„ç† â†’ [ç‰©æµæ¶ˆæ¯] â†’ æœ€ç»ˆå¤„ç†
```

æ¯ä¸ªå¤„ç†å™¨æ—¢æ˜¯æ¶ˆè´¹è€…ï¼ˆæ¥æ”¶ä¸Šæ¸¸æ¶ˆæ¯ï¼‰ï¼Œåˆæ˜¯ç”Ÿäº§è€…ï¼ˆå‘é€ä¸‹æ¸¸æ¶ˆæ¯ï¼‰ã€‚

## API æ–‡æ¡£

### MessageBus

#### `subscribe(msg_type, subscriber_queue)`
è®¢é˜…æŒ‡å®šç±»å‹çš„æ¶ˆæ¯

**å‚æ•°**:
- `msg_type`: MessageType - æ¶ˆæ¯ç±»å‹
- `subscriber_queue`: Queue - è®¢é˜…è€…çš„æ¶ˆæ¯é˜Ÿåˆ—

#### `publish(message)`
å‘å¸ƒæ¶ˆæ¯åˆ°æ€»çº¿

**å‚æ•°**:
- `message`: Message - æ¶ˆæ¯å¯¹è±¡

#### `get_stats()`
è·å–æ€»çº¿ç»Ÿè®¡ä¿¡æ¯

**è¿”å›**: Dict[str, int] - å„æ¶ˆæ¯ç±»å‹çš„è®¢é˜…è€…æ•°é‡

### Producer

#### `__init__(name, bus, msg_type, count)`
åˆ›å»ºç”Ÿäº§è€…

**å‚æ•°**:
- `name`: str - ç”Ÿäº§è€…åç§°
- `bus`: MessageBus - æ¶ˆæ¯æ€»çº¿
- `msg_type`: MessageType - ç”Ÿäº§çš„æ¶ˆæ¯ç±»å‹
- `count`: int - ç”Ÿäº§æ¶ˆæ¯æ•°é‡

### Consumer

#### `__init__(name, bus, interested_types, count)`
åˆ›å»ºæ¶ˆè´¹è€…

**å‚æ•°**:
- `name`: str - æ¶ˆè´¹è€…åç§°
- `bus`: MessageBus - æ¶ˆæ¯æ€»çº¿
- `interested_types`: List[MessageType] - è®¢é˜…çš„æ¶ˆæ¯ç±»å‹åˆ—è¡¨
- `count`: int - æ¶ˆè´¹æ¶ˆæ¯æ•°é‡

## åº”ç”¨åœºæ™¯

### 1. å¾®æœåŠ¡æ¶æ„
- æœåŠ¡é—´é€šè¿‡æ¶ˆæ¯æ€»çº¿è§£è€¦
- æ”¯æŒå¼‚æ­¥é€šä¿¡å’Œäº‹ä»¶é©±åŠ¨
- ç±»ä¼¼ RabbitMQã€Kafka çš„ç®€åŒ–å®ç°

### 2. æ—¥å¿—ç³»ç»Ÿ
- å¤šä¸ªæ¨¡å—äº§ç”Ÿæ—¥å¿—ï¼ˆç”Ÿäº§è€…ï¼‰
- æ—¥å¿—æ”¶é›†å™¨ã€åˆ†æå™¨ã€å­˜å‚¨å™¨ï¼ˆæ¶ˆè´¹è€…ï¼‰
- ä¸åŒçº§åˆ«çš„æ—¥å¿—è·¯ç”±åˆ°ä¸åŒå¤„ç†å™¨

### 3. ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ
- ä»»åŠ¡ç”Ÿæˆå™¨åˆ›å»ºä»»åŠ¡
- å¤šä¸ª Worker è®¢é˜…å¹¶æ‰§è¡Œä»»åŠ¡
- æ”¯æŒä»»åŠ¡ç±»å‹åˆ†ç±»å’Œä¼˜å…ˆçº§

### 4. å®æ—¶æ•°æ®å¤„ç†
- æ•°æ®é‡‡é›†å™¨æŒç»­äº§ç”Ÿæ•°æ®
- æ•°æ®æ¸…æ´—ã€è½¬æ¢ã€å­˜å‚¨ç­‰å¤šä¸ªå¤„ç†é˜¶æ®µ
- æ„å»ºæ•°æ®å¤„ç†æµæ°´çº¿

### 5. ç”µå•†è®¢å•ç³»ç»Ÿ
- è®¢å•åˆ›å»º â†’ æ”¯ä»˜ç¡®è®¤ â†’ åº“å­˜æ‰£å‡ â†’ ç‰©æµå‘è´§
- æ¯ä¸ªç¯èŠ‚ç‹¬ç«‹æœåŠ¡ï¼Œé€šè¿‡æ¶ˆæ¯åä½œ
- æ˜“äºæ‰©å±•å’Œç»´æŠ¤

## æŠ€æœ¯ç»†èŠ‚

### çº¿ç¨‹å®‰å…¨

ä½¿ç”¨ `threading.Lock` ä¿æŠ¤å…±äº«èµ„æºï¼š

```python
with self.lock:
    self.subscribers[msg_type].append(subscriber_queue)
```

### æ¶ˆæ¯é˜Ÿåˆ—

æ¯ä¸ªæ¶ˆè´¹è€…ç»´æŠ¤ç‹¬ç«‹çš„ `queue.Queue`ï¼š
- çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—å®ç°
- æ”¯æŒé˜»å¡å’Œè¶…æ—¶æ“ä½œ
- è‡ªåŠ¨å¤„ç†æ»¡é˜Ÿåˆ—æƒ…å†µ

### æ¶ˆæ¯åˆ†å‘æœºåˆ¶

```python
# ä¸€æ¡æ¶ˆæ¯åˆ†å‘ç»™æ‰€æœ‰è®¢é˜…è€…
for sub_queue in subscribers:
    sub_queue.put(message)
```

### ä¼˜é›…é€€å‡º

- ç”Ÿäº§è€…ä½¿ç”¨ `join()` ç­‰å¾…å®Œæˆ
- æ¶ˆè´¹è€…ä½¿ç”¨ `daemon=True` æˆ–å¸¦è¶…æ—¶çš„ `join()`
- é¿å…ä¸»çº¿ç¨‹æ— é™ç­‰å¾…

## æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–å»ºè®®

1. **é˜Ÿåˆ—å¤§å°**: æ ¹æ®å®é™…æƒ…å†µè®¾ç½® `maxsize`ï¼Œé¿å…å†…å­˜æº¢å‡º
2. **æ‰¹é‡å¤„ç†**: æ¶ˆè´¹è€…å¯ä»¥æ‰¹é‡è·å–æ¶ˆæ¯æé«˜æ•ˆç‡
3. **å¼‚æ­¥IO**: å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œè€ƒè™‘